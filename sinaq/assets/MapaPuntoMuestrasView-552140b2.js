import{a4 as O,u as N,a5 as E,k as i,c as U,$ as B,o as f,y as x,e as t,d as l,B as T,O as j,F as M,i as q,P as D,h as n,a6 as R,f as s,_ as F,n as C,a7 as G,a8 as K,C as H,b as Y,A as m,p as Z}from"./index-72c1ed64.js";import{i as J,v as Q,u as L,L as h,b as z,g as W,y as X}from"./maps-5273b09b.js";import{_ as ee}from"./FormAnalitica-c9a22686.js";import"./useFormSelectData-52f7ab35.js";const ae="/sinaq/assets/aqlara-icon-192-2ad0df88.png";const oe={class:"flex flex-col items-center justify-center"},te={style:{height:"600px",width:"95%"}},se={class:"text-center"},ne={class:"text-center"},le={class:"text-lg font-bold"},ie={class:"text-sm"},ce={class:"text-center"},re={class:"text-lg font-bold"},ue={class:"text-sm"},de={__name:"MapaPuntoMuestrasView",setup(fe){const u=N(),g=E(),c=i(!1),r=i(null),d=i(!1),y=i(null),p=i(null),_=i([39.4679255214283,-.3762874990439122]),v=i(13),w="d6ae26b3d87042278ec375bbfc9d89ac",I=a=>h.icon({iconUrl:`https://api.geoapify.com/v1/icon/?type=material&color=blue&icon=${a}&iconType=awesome&apiKey=${w}`,iconSize:[31,46],iconAnchor:[15.5,42],popupAnchor:[0,-45]}),S=a=>{c.value=!0,r.value=a},k=U(()=>{if(g.userRole===99)return u.getPuntosMuestreo.filter(e=>e.activo);const a=u.getOperarios.find(e=>e.email?.toLowerCase()===g.userEmail?.toLowerCase());if(!a||!a.zonas||a.zonas.length===0)return console.warn("Operario sin zonas asignadas:",g.userEmail),[];const o=a.zonas.map(e=>typeof e=="object"?e.id:e);return console.log("Zonas asignadas al operario:",o),u.getPuntosMuestreo.filter(e=>e.activo&&o.includes(e.zona_fk))}),P=async()=>{await u.loadAnaliticas(),c.value=!1,r.value=null},A=()=>{c.value=!1,r.value=null},V=a=>{const o={lat:a.target.getLatLng().lat,lon:a.target.getLatLng().lng};console.log("New position:",o),console.log(a.target.getLatLng())},b=()=>{if(!navigator.geolocation){console.error("Geolocalización no soportada por este navegador");return}d.value=!0,y.value=null,console.log("Solicitando ubicación del usuario..."),navigator.geolocation.getCurrentPosition(a=>{console.log("Ubicación obtenida:",a.coords),_.value=[a.coords.latitude,a.coords.longitude],d.value=!1,p.value&&(console.log("Actualizando centro del mapa"),p.value.leafletObject.setView(_.value,v.value))},a=>{console.error("Error de geolocalización:",a.message),y.value=a.message,d.value=!1,(a.code===a.TIMEOUT||a.code===a.POSITION_UNAVAILABLE)&&setTimeout(()=>{console.log("Reintentando obtener ubicación..."),b()},2e3)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},$=()=>{b()};return B(()=>{console.log("Componente montado, solicitando ubicación..."),setTimeout(()=>{b()},500)}),(a,o)=>(f(),x(M,null,[t(T,{modelValue:c.value,"onUpdate:modelValue":o[0]||(o[0]=e=>c.value=e),title:"Nueva analitica en "+r.value?.name,"no-button":"",class:"modal-overlay","modal-size":"xl",onConfirm:P,onCancel:A},{default:l(()=>[t(ee,{"initial-position":r.value?.id,class:"h-full",onCloseModal:A},null,8,["initial-position"])]),_:1},8,["modelValue","title"]),t(j,null,{default:l(()=>[t(q,null,{default:l(()=>[t(D,{icon:n(R),title:"Mapa Puntos Muestreo",main:""},{default:l(()=>o[2]||(o[2]=[s("div",{class:"flex gap-2"},null,-1)])),_:1},8,["icon"]),t(F,{class:"mb-6","has-table":""},{default:l(()=>[s("div",oe,[s("div",te,[t(C,{label:"Centrar posición",icon:n(G),color:"info",rounded:"",small:"",disabled:d.value,class:"w-full",onClick:$},null,8,["icon","disabled"]),t(n(J),{ref_key:"map",ref:p,zoom:v.value,"onUpdate:zoom":o[1]||(o[1]=e=>v.value=e),center:_.value,"use-global-leaflet":!1},{default:l(()=>[t(n(Q),{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","layer-type":"base",name:"OpenStreetMap"}),t(n(L),{"lat-lng":[39.54982998070428,-.4656852311920545],icon:n(h).icon({iconUrl:n(ae),iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})},{default:l(()=>[t(n(z),null,{default:l(()=>[s("div",se,[t(K,{class:"text-center w-32"}),o[3]||(o[3]=s("p",{class:"text-sm"},"Oficinas Centrales",-1)),o[4]||(o[4]=s("p",{class:"text-sm"},"Rda. de Narcís Monturiol, nº 4",-1)),o[5]||(o[5]=s("p",{class:"text-sm"}," oficina 214-A, 46980 Paterna, Valencia",-1)),o[6]||(o[6]=s("p",{class:"text-sm"}," Tfno: 963 153 232",-1))])]),_:1})]),_:1},8,["icon"]),(f(!0),x(M,null,H(k.value,e=>(f(),x("div",{key:e.id},[e.posicion?(f(),Y(n(L),{key:0,"lat-lng":[e.posicion.lat,e.posicion.lon],draggable:"",icon:I(n(W)(e.infraestructura_fk)),onDragend:V},{default:l(()=>[t(n(z),null,{default:l(()=>[s("div",ne,[s("h1",le,m(e.name),1),s("p",ie,"id: "+m(e.id),1)])]),_:2},1024),t(n(X),null,{default:l(()=>[s("div",ce,[s("h1",re,m(e.name),1),s("p",ue,"SINAC Id: "+m(e.id),1),t(C,{label:"Añadir analítica",color:"info",onClick:me=>S(e)},null,8,["onClick"])])]),_:2},1024)]),_:2},1032,["lat-lng","icon"])):Z("",!0)]))),128))]),_:1},8,["zoom","center"])])])]),_:1})]),_:1})]),_:1})],64))}},be=O(de,[["__scopeId","data-v-8186ffc3"]]);export{be as default};
