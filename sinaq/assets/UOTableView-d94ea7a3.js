import{u as z,r as B,c as V,w as D,o as f,b as N,d as _,e as n,_ as F,m as Z,n as U,f as a,g as P,h as v,Q as x,y as w,p as S,i as q,j as R,k as O,z as M,A as C,B as L,F as $,C as T,E as I,R as Y,S as H,T as X,U as j,G,H as Q,O as K,P as W,V as J,W as ee}from"./index-72c1ed64.js";import{_ as ae}from"./CardBoxModalForm-4ae1fe9d.js";import{_ as oe}from"./FlagIcons-3914a5ae.js";const le={class:"grid grid-cols-1 lg:grid-cols-6 mb-6 gap-4 w-full"},ne={class:"col-span-1 w-full"},te={class:"col-span-5 w-full"},se={key:0,class:"grid md-grid-cols-1 md:grid-cols-1 gap-4 mb-6"},re={__name:"FormUO",props:{uo:{type:Object,required:!0,default:()=>({})}},emits:["submit","closeModal"],setup(c,{expose:d,emit:p}){const g=p,u=z(),t=c,e=B({id:t.uo?.id||null,name:t.uo?.name,description:t.uo?.description,zonas:[]}),b=()=>{if(console.log("submitHandler"),!e.name||!e.description)return console.error("Faltan campos requeridos"),!1;const r={id:e.id,name:e.name,description:e.description,zonas:e.zonas};g("submit",r)},E=V(()=>u.getComunidadesAutonomas.map(r=>({value:r.id,label:r.name}))),A=r=>u.getZonas.filter(i=>i.com_autonoma_fk===r).map(i=>({value:i.id,label:i.name})),k=V(()=>{const r=u.getZonas.map(s=>({value:s.id,label:s.name}));return console.log("ZONAS: ",r),r});D(()=>t.uo,r=>{e.id=r?.id,e.name=r?.name,e.description=r?.description,h(r?.id)},{inmediate:!0});const h=async r=>{if(!r)return console.warn("El valor de id es undefined o null"),[];const s=u.getZonas.filter(i=>i.unidades_operativas_fk===r).map(i=>i.id);console.log("ZONAS SELECCIONADAS: ",s),e.zonas=s};return h(e.id),d({submitHandler:b}),(r,s)=>(f(),N(q,null,{default:_(()=>[n(F,{"is-form":""},{footer:_(()=>[n(Z,null,{default:_(()=>[n(U,{type:"submit",color:"info",label:"Guardar",onClick:s[4]||(s[4]=i=>g("submit",e))}),n(U,{type:"reset",color:"danger",outline:"",label:"Cancelar",onClick:s[5]||(s[5]=i=>g("closeModal"))})]),_:1})]),default:_(()=>[a("form",{class:"w-full",onSubmit:P(b,["prevent"])},[a("div",le,[a("div",ne,[n(v(x),{modelValue:e.name,"onUpdate:modelValue":s[0]||(s[0]=i=>e.name=i),type:"text",label:"C贸digo",placeholder:"C贸digo",validation:"required",class:"col-span-1 w-full"},null,8,["modelValue"])]),a("div",te,[n(v(x),{modelValue:e.description,"onUpdate:modelValue":s[1]||(s[1]=i=>e.description=i),type:"text",label:"Nombre",placeholder:"Nombre",validation:"required",class:"col-span-3 w-full"},null,8,["modelValue"])])]),n(v(x),{modelValue:e.comunidadAutonoma,"onUpdate:modelValue":s[2]||(s[2]=i=>e.comunidadAutonoma=i),options:E.value,type:"select",label:"Comunidad Autonoma",placeholder:"Comunidad Autonoma",class:"w-full","option-class":"w-full"},null,8,["modelValue","options"]),e.comunidadAutonoma?(f(),w("div",se,[n(v(x),{modelValue:e.zonas,"onUpdate:modelValue":s[3]||(s[3]=i=>e.zonas=i),options:e.comunidadAutonoma?A(e.comunidadAutonoma):k.value,label:"Zonas",type:"checkbox",name:"zonas","options-class":"w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-2 space-y-2 p-4 rounded-md","option-class":"flex items-center"},null,8,["modelValue","options"])])):S("",!0)],32)]),_:1})]),_:1}))}},ie=async c=>{console.log(c);try{const{data:d,error:p}=await R.from("unidades_operativas").upsert({id:c,activo:!1},{onConflict:["id"]}).select();if(p)throw console.error("Error SQL:",p),p;return d}catch(d){throw console.error("Error en anularUO:",d),d}},de=async c=>{try{const{data:d}=await R.from("unidades_operativas").insert({name:c.name,description:c.description}).select();return d}catch(d){throw console.error("Error en createUO:",d),d}},ue=async c=>{const g=async(u=0)=>{try{if(!c.id||!c.name||!c.description)throw new Error("Faltan campos requeridos");const{data:t,error:e}=await R.from("unidades_operativas").update({name:c.name,description:c.description}).eq("id",c.id).select().single();if(e)throw e;return t}catch(t){if(u<3)return console.log(`Reintento ${u+1} de 3`),await new Promise(e=>setTimeout(e,1e3)),g(u+1);throw t}};try{return await g()}catch(u){throw console.error("Error en updateUO:",u),new Error(`Error al actualizar UO: ${u.message}`)}},ce={class:"border-b-0 lg:w-6 before:hidden"},me={"data-label":"Code"},pe={"data-label":"Name"},fe={colspan:"2"},ve={class:"px-4"},_e={key:0,class:"flex items-center text-gray-500 py-2"},ge={key:1,class:"space-y-2"},be={class:"text-sm"},we={class:"w-1"},ye={class:"flex flex-col items-center space-y-2"},Oe={__name:"UOTable",props:{checkable:{type:Boolean,default:!1}},setup(c,{expose:d}){const p=z(),g=V(()=>p.unidadesOperativas.filter(o=>o.activo)),u=O(!1),t=O(null),e=O(!1),b=O([]),E=o=>p.getZonas.filter(l=>l.unidades_operativas_fk===o),A=o=>{b.value.includes(o)?b.value=b.value.filter(l=>l!==o):b.value.push(o)},k=o=>{t.value=o,e.value=!0},h=()=>{e.value=!1,t.value=null},r=o=>{t.value=o,u.value=!0},s=async()=>{try{const o=t.value.id;await ie(o),await p.loadUnidadesOperativas(),u.value=!1,t.value=null,alert("Unidad Operativa eliminada correctamente")}catch(o){console.log("error al borrar UO: ",o),alert("error al borrar UO: ")}},i=async o=>{o.id?(console.log("Formulario Editado:",o),await ue(o)):(console.log("Formulario Nuevo:",o.id),await de(o)),await p.loadUnidadesOperativas(),h()};return D(g,o=>{console.log("Unidades Operativas:",o)}),d({openModal:k}),(o,l)=>(f(),w($,null,[t.value!==null?(f(),N(ae,{key:0,modelValue:e.value,"onUpdate:modelValue":l[0]||(l[0]=m=>e.value=m),uo:t.value,title:t.value?`Editar Unidad Operativa ${t.value?.description}`:"Crear Nueva Unidad Operativa","has-cancel":""},{default:_(()=>[n(re,{uo:t.value,onSubmit:i,onCloseModal:h},null,8,["uo"])]),_:1},8,["modelValue","uo","title"])):S("",!0),n(L,{modelValue:u.value,"onUpdate:modelValue":l[1]||(l[1]=m=>u.value=m),title:"Eliminar Unidad Operativa",button:"danger","has-cancel":"",onConfirm:s},{default:_(()=>[a("p",null,[l[2]||(l[2]=M(" Esta seguro que desea eliminar la Unidad Operativa ")),a("b",null,C(t.value?.name)+" ("+C(t.value?.description)+")",1),l[3]||(l[3]=M("? "))]),l[4]||(l[4]=a("p",null,"Esta operaci贸n no se puede deshacer.",-1))]),_:1},8,["modelValue"]),a("div",null,[a("table",null,[l[8]||(l[8]=a("thead",null,[a("tr",null,[a("th",null,"ID"),a("th",null,"C贸digo"),a("th",null,"Nombre"),a("th")])],-1)),a("tbody",null,[(f(!0),w($,null,T(g.value,m=>(f(),w($,{key:m.id},[a("tr",null,[a("td",ce,[n(I,{username:m.name.slice(-2),class:"w-24 h-24 mx-auto lg:w-6 lg:h-6"},null,8,["username"])]),a("td",me,C(m.name),1),a("td",pe,C(m.description),1),a("td",null,[n(U,{icon:b.value.includes(m.id)?v(Y):v(H),color:"info",onClick:y=>A(m.id)},null,8,["icon","onClick"])])]),b.value.includes(m.id)?(f(),w("tr",{key:`expanded-${m.id}`},[l[7]||(l[7]=a("td",null,null,-1)),a("td",fe,[l[6]||(l[6]=a("p",{class:"font-bold"},"Zonas",-1)),a("div",ve,[E(m.id).length===0?(f(),w("div",_e,[n(j,{path:v(X),class:"w-5 h-5 mr-2"},null,8,["path"]),l[5]||(l[5]=a("span",{class:"text-sm italic"},"No hay zonas asignadas",-1))])):(f(),w("ul",ge,[(f(!0),w($,null,T(E(m.id),y=>(f(),w("li",{key:y.id,class:"flex items-center text-gray-700 hover:text-blue-600 transition-colors duration-200"},[n(oe,{comunidad:y.com_autonoma_fk},null,8,["comunidad"]),a("span",be,C(y.name),1)]))),128))]))])]),a("td",we,[a("div",ye,[n(Z,{class:"pl-8"},{default:_(()=>[n(U,{icon:v(G),color:"info",onClick:y=>k(m)},null,8,["icon","onClick"]),n(U,{icon:v(Q),color:"danger",onClick:y=>r(m)},null,8,["icon","onClick"])]),_:2},1024)])])])):S("",!0)],64))),128))])])])],64))}},Ue={class:"flex gap-2"},ke={__name:"UOTableView",setup(c){O(!1);const d=O(null),p=()=>{d.value.openModal()};return(g,u)=>(f(),N(K,null,{default:_(()=>[n(q,null,{default:_(()=>[n(W,{icon:v(J),title:"Unidades Operativas",main:""},{default:_(()=>[a("div",Ue,[n(U,{target:"_blank",icon:v(ee),label:"Nueva Unidad Operativa",color:"info",outline:"","rounded-full":"",small:"",onClick:p},null,8,["icon"])])]),_:1},8,["icon"]),n(F,{class:"mb-6","has-table":""},{default:_(()=>[n(Oe,{ref_key:"table",ref:d},null,512)]),_:1})]),_:1})]),_:1}))}};export{ke as default};
