import{u as B,r as Q,c as $,w as q,o as f,b as O,d as v,e as t,_ as I,m as T,n as C,f as e,g as j,h as p,Q as h,y as k,p as U,i as L,j as P,k as x,z as M,A as y,B as G,F as V,C as D,R,S as K,T as W,U as F,X,G as J,H as Y,O as z,P as ee,V as ae,W as oe}from"./index-72c1ed64.js";import{_ as le}from"./CardBoxModalForm-4ae1fe9d.js";import{_ as ne}from"./FlagIcons-3914a5ae.js";const te={class:"grid grid-cols-1 lg:grid-cols-6 mb-6 gap-4 w-full"},se={class:"col-span-1 w-full"},ie={class:"col-span-5 w-full"},de={class:"flex flex-col w-full md:flex-row md:space-x-4 md:space-y-0 space-y-4 mb-6"},re={key:0,class:"grid md-grid-cols-1 md:grid-cols-1 gap-4 mb-6"},ue={__name:"FormZona",props:{uo:{type:Object,required:!0,default:()=>({esNuevo:!0})}},emits:["submit","closeModal"],setup(m,{expose:d,emit:u}){const g=u,_=B(),r=m,a=Q({esNuevo:r.uo?.esNuevo??!0,id:r.uo?.id||null,name:r.uo?.name,com_autonoma_fk:r.uo?.com_autonoma_fk,unidades_operativas_fk:r.uo?.unidades_operativas_fk,zonas:[]}),b=()=>{if(console.log("submitHandler"),!a.name||!a.com_autonoma_fk||!a.unidades_operativas_fk)return console.error("Faltan campos requeridos"),!1;const n={id:a.id,name:a.name,com_autonoma_fk:a.com_autonoma_fk,unidades_operativas_fk:a.com_autonoma_fk,zonas:a.zonas};g("submit",n)},N=$(()=>_.getComunidadesAutonomas.map(n=>({value:n.id,label:n.name}))),S=$(()=>_.getUnidadesOperativas.map(n=>({value:n.id,label:n.name}))),A=n=>_.getZonas.filter(i=>i.com_autonoma_fk===n).map(i=>({value:i.id,label:i.name})),E=$(()=>{const n=_.getZonas.map(s=>({value:s.id,label:s.name}));return console.log("ZONAS: ",n),n});q(()=>r.uo,n=>{a.esNuevo=n?.esNuevo,a.id=n?.id,a.name=n?.name,a.com_autonoma_fk=n?.com_autonoma_fk,a.unidades_operativas_fk=n?.unidades_operativas_fk,Z(n?.id)},{inmediate:!0});const Z=async n=>{if(!n)return console.warn("El valor de id es undefined o null"),[];const s=_.getZonas.filter(i=>i.unidades_operativas_fk===n).map(i=>i.id);a.zonas=s};return Z(a.id),d({submitHandler:b}),(n,s)=>(f(),O(L,null,{default:v(()=>[t(I,{"is-form":""},{footer:v(()=>[t(T,null,{default:v(()=>[t(C,{type:"submit",color:"info",label:"Guardar",onClick:s[5]||(s[5]=i=>g("submit",a))}),t(C,{type:"reset",color:"danger",outline:"",label:"Cancelar",onClick:s[6]||(s[6]=i=>g("closeModal"))})]),_:1})]),default:v(()=>[e("form",{class:"w-full",onSubmit:j(b,["prevent"])},[e("div",te,[e("div",se,[t(p(h),{modelValue:a.id,"onUpdate:modelValue":s[0]||(s[0]=i=>a.id=i),type:"text",label:"Código",placeholder:"Nº SINAC",validation:"required",class:"col-span-1 w-full",disabled:!a.esNuevo},null,8,["modelValue","disabled"])]),e("div",ie,[t(p(h),{modelValue:a.name,"onUpdate:modelValue":s[1]||(s[1]=i=>a.name=i),type:"text",label:"Nombre",placeholder:"Nombre",validation:"required",class:"col-span-3 w-full"},null,8,["modelValue"])])]),e("div",de,[t(p(h),{modelValue:a.com_autonoma_fk,"onUpdate:modelValue":s[2]||(s[2]=i=>a.com_autonoma_fk=i),options:N.value,type:"select",label:"Comunidad Autonoma",placeholder:"Comunidad Autonoma",class:"w-full","option-class":"w-full"},null,8,["modelValue","options"]),t(p(h),{modelValue:a.unidades_operativas_fk,"onUpdate:modelValue":s[3]||(s[3]=i=>a.unidades_operativas_fk=i),options:S.value,type:"select",label:"Unidad Operativa",placeholder:"Comunidad Autonoma",class:"w-full","option-class":"w-full"},null,8,["modelValue","options"])]),a.comunidadAutonoma?(f(),k("div",re,[t(p(h),{modelValue:a.zonas,"onUpdate:modelValue":s[4]||(s[4]=i=>a.zonas=i),options:a.comunidadAutonoma?A(a.comunidadAutonoma):E.value,label:"Zonas",type:"checkbox",name:"zonas","options-class":"w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-2 space-y-2 p-4 rounded-md","option-class":"flex items-center"},null,8,["modelValue","options"])])):U("",!0)],32)]),_:1})]),_:1}))}},ce=async m=>{try{const{data:d}=await P.from("zonas_abastecimiento").insert({id:m.id,name:m.name,com_autonoma_fk:m.com_autonoma_fk,unidades_operativas_fk:m.unidades_operativas_fk}).select().single();return d}catch(d){throw console.error("Error en setZona:",d),d}},me=async m=>{console.log("ID: ",m);try{const{data:d,error:u}=await P.from("zonas_abastecimiento").upsert({id:m,activa:!1},{onConflict:["id"]}).select();if(u)throw console.error("Error SQL:",u),u;return d}catch(d){throw console.error("Error en anularUO:",d),d}},pe=async m=>{try{const{data:d,error:u}=await P.from("zonas_abastecimiento").update({name:m.name,com_autonoma_fk:m.com_autonoma_fk,unidades_operativas_fk:m.unidades_operativas_fk}).eq("id",m.id).select().single();if(u)throw console.error("Error SQL:",u),u;return d}catch(d){console.log("Error en updateZona:",d)}},fe={"data-label":"ID"},_e={"data-label":"Name"},ve={"data-label":"Comunidad Autonoma"},be={class:"flex items-center space-x-2"},ke={"data-label":"Unidad Operativa"},ge={colspan:"3"},ye={class:"px-4"},xe={key:0,class:"flex items-center text-gray-500 py-2"},Ce={key:1,class:"space-y-2"},Ze={class:"text-sm"},we={class:"w-1"},he={class:"flex flex-col items-center space-y-2"},Ae={__name:"ZonasTable",props:{checkable:{type:Boolean,default:!1}},setup(m,{expose:d}){const u=B(),g=$(()=>u.getZonas.filter(l=>l.activa)),_=x(!1),r=x(null),a=x(!1),b=x([]),N=l=>u.getComunidadesAutonomas.find(o=>o.id===l)?.name??"Sin Comunidad Asignada",S=l=>u.getUnidadesOperativas.find(o=>o.id===l)?.name??"Sin Unidad Operativa Asignada",A=l=>u.getPuntosMuestreo.filter(o=>o.zona_fk===l).map(o=>({name:o.name,id:o.id})),E=l=>{b.value.includes(l)?b.value=b.value.filter(o=>o!==l):b.value.push(l)},Z=l=>{r.value=l,console.log("openModal:",r.value),a.value=!0},n=()=>{a.value=!1,r.value=null},s=l=>{r.value=l,_.value=!0},i=async()=>{try{const l=r.value.id;await me(l),await u.loadZonas(),_.value=!1,r.value=null,alert("Zona de Abastecimiento eliminada correctamente")}catch(l){console.log("error al borrar Zona de Abastecimiento: ",l),alert("error al borrar Zona de Abastecimiento: ")}},H=async l=>{l.esNuevo?(console.log("Formulario Nuevo:",l.id),await ce(l)):(console.log("Formulario Editado:",l),await pe(l)),await u.loadZonas(),n()};return q(g,l=>{console.log("Zonas de Abastecimiento:",l)}),d({openModal:Z}),(l,o)=>(f(),k(V,null,[r.value!==null?(f(),O(le,{key:0,modelValue:a.value,"onUpdate:modelValue":o[0]||(o[0]=c=>a.value=c),uo:r.value,title:r.value?.id?`Editar Zona de Abastecimiento ${r.value?.name}`:"Crear Nueva Zona de Abastecimiento","has-cancel":""},{default:v(()=>[t(ue,{uo:r.value,onSubmit:H,onCloseModal:n},null,8,["uo"])]),_:1},8,["modelValue","uo","title"])):U("",!0),t(G,{modelValue:_.value,"onUpdate:modelValue":o[1]||(o[1]=c=>_.value=c),title:"Eliminar Zona de Abastecimiento",button:"danger","has-cancel":"",onConfirm:i},{default:v(()=>[e("p",null,[o[2]||(o[2]=M(" Esta seguro que desea eliminar la Zona de Abastecimiento ")),e("b",null,y(r.value?.name),1),o[3]||(o[3]=M("? "))]),o[4]||(o[4]=e("p",null,"Esta operación no se puede deshacer.",-1))]),_:1},8,["modelValue"]),e("div",null,[e("table",null,[o[9]||(o[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ID"),e("th",null,"Nombre"),e("th",null,"Comunidad Autonoma"),e("th",null,"Unidad Operativa"),e("th")])],-1)),e("tbody",null,[(f(!0),k(V,null,D(g.value,c=>(f(),k(V,{key:c.id},[e("tr",null,[o[5]||(o[5]=e("td",{class:"border-b-0 lg:w-6 before:hidden"},null,-1)),e("td",fe,y(c.id),1),e("td",_e,y(c.name),1),e("td",ve,[e("div",be,[t(ne,{comunidad:c.com_autonoma_fk,class:"rounded"},null,8,["comunidad"]),M(" "+y(N(c.com_autonoma_fk)),1)])]),e("td",ke,y(S(c.unidades_operativas_fk)),1),e("td",null,[t(C,{icon:b.value.includes(c.id)?p(R):p(K),color:"info",onClick:w=>E(c.id)},null,8,["icon","onClick"])])]),b.value.includes(c.id)?(f(),k("tr",{key:`expanded-${c.id}`},[o[8]||(o[8]=e("td",null,null,-1)),e("td",ge,[o[7]||(o[7]=e("p",{class:"font-bold"},"Puntos de Muestreo",-1)),e("div",ye,[A(c.id).length===0?(f(),k("div",xe,[t(F,{path:p(W),class:"w-5 h-5 mr-2"},null,8,["path"]),o[6]||(o[6]=e("span",{class:"text-sm italic"},"No hay puntos de muestreo asignados",-1))])):(f(),k("ul",Ce,[(f(!0),k(V,null,D(A(c.id),w=>(f(),k("li",{key:w.id,class:"flex items-center text-gray-700 hover:text-blue-600 transition-colors duration-200"},[t(F,{path:p(X),class:"w-5 h-5 mr-2 text-blue-500"},null,8,["path"]),e("span",Ze,y(w.name),1)]))),128))]))])]),e("td",we,[e("div",he,[t(T,{class:"pl-8"},{default:v(()=>[t(C,{icon:p(J),color:"info",onClick:w=>Z({...c,esNuevo:!1})},null,8,["icon","onClick"]),t(C,{icon:p(Y),color:"danger",onClick:w=>s(c)},null,8,["icon","onClick"])]),_:2},1024)])])])):U("",!0)],64))),128))])])])],64))}},Ve={class:"flex gap-2"},Ee={__name:"ZonasAdminView",setup(m){x(!1);const d=x(null),u=()=>{d.value.openModal()};return(g,_)=>(f(),O(z,null,{default:v(()=>[t(L,null,{default:v(()=>[t(ee,{icon:p(ae),title:"Zonas",main:""},{default:v(()=>[e("div",Ve,[t(C,{target:"_blank",icon:p(oe),label:"Nueva Zona",color:"info",outline:"","rounded-full":"",small:"",onClick:u},null,8,["icon"])])]),_:1},8,["icon"]),t(I,{class:"mb-6","has-table":""},{default:v(()=>[t(Ae,{ref_key:"table",ref:d},null,512)]),_:1})]),_:1})]),_:1}))}};export{Ee as default};
